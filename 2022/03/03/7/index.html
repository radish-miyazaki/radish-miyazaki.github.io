<!DOCTYPE html>
<html lang="ja-jp">
  <head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Transition Heroku Redis from Hobby_Dev to Premium on ROR | method_missing(*)</title>
  <link rel="stylesheet" href="https://radish-miyazaki.github.io/assets/css/post.css" />
  <script defer src="https://radish-miyazaki.github.io/assets/js/lbox.js"></script>
  
  <link rel="stylesheet" href="https://radish-miyazaki.github.io/assets/css/common.css" />
  <link rel="icon" type="image/png" href="https://radish-miyazaki.github.io/assets/icons/ruby.png" />
  <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://radish-miyazaki.github.io/post-cover.png"/>

<meta name="twitter:title" content="Transition Heroku Redis from Hobby_Dev to Premium on ROR"/>
<meta name="twitter:description" content="概要 Heroku Dyno, PostgreSQL, Redisの無料プランが10月末日から廃止になるので、開発環境のRedisを有料プランに移行した。
その際に少々ハマってしまったので、まとめておく。
 開発環境  Rails: 6.1.1.4 Ruby: 2.7.5 Redis: 6.2.3   Hobby_Dev と Premiumの違い Hobby_DevではTLSの有無に関わらず接続が可能だが、PremiumでかつRedisのバージョンが6の場合は、TLS接続が必須となっている。
ただし、Heroku側で設定は自動で行ってくれているので、クライアント側ではSSLでの接続をオフにするように設定を追加するだけで良い。
 クライアント（Rails）での対応 Redisインスタンスの初期設定 config/initializersディレクトリ直下に、redis.rbファイルを作成し、Redisインスタンスの設定を追加。
if Rails.env.production? $redis = Redis."/>

  <meta property="og:title" content="Transition Heroku Redis from Hobby_Dev to Premium on ROR" />
<meta property="og:description" content="概要 Heroku Dyno, PostgreSQL, Redisの無料プランが10月末日から廃止になるので、開発環境のRedisを有料プランに移行した。
その際に少々ハマってしまったので、まとめておく。
 開発環境  Rails: 6.1.1.4 Ruby: 2.7.5 Redis: 6.2.3   Hobby_Dev と Premiumの違い Hobby_DevではTLSの有無に関わらず接続が可能だが、PremiumでかつRedisのバージョンが6の場合は、TLS接続が必須となっている。
ただし、Heroku側で設定は自動で行ってくれているので、クライアント側ではSSLでの接続をオフにするように設定を追加するだけで良い。
 クライアント（Rails）での対応 Redisインスタンスの初期設定 config/initializersディレクトリ直下に、redis.rbファイルを作成し、Redisインスタンスの設定を追加。
if Rails.env.production? $redis = Redis." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://radish-miyazaki.github.io/2022/03/03/7/" /><meta property="og:image" content="https://radish-miyazaki.github.io/post-cover.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-03T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-03-03T00:00:00+00:00" />


</head>
  <body>
    <main>
      <header>
  <a class="site-title" href="https://radish-miyazaki.github.io">method_missing(*)</a>
</header>

      <section class="article">
        <div class="article-header">
          <h2 class="article-title">Transition Heroku Redis from Hobby_Dev to Premium on ROR</h2>
          <small class="date">2022-03-03 (Thu)</small>
          <div class="tags">
            
            <a href="https://radish-miyazaki.github.io/tags/ruby" class="tag">ruby</a>
            
            <a href="https://radish-miyazaki.github.io/tags/rails" class="tag">rails</a>
            
            <a href="https://radish-miyazaki.github.io/tags/heroku" class="tag">heroku</a>
            
          </div>
        </div>
        <div class="content"><h2 id="概要">概要</h2>
<p>Heroku Dyno, PostgreSQL, Redisの無料プランが<a href="https://blog.heroku.com/next-chapter#focus-on-mission-critical">10月末日から廃止</a>になるので、開発環境のRedisを有料プランに移行した。</p>
<p>その際に少々ハマってしまったので、まとめておく。</p>
<hr>
<h2 id="開発環境">開発環境</h2>
<ul>
<li>Rails: 6.1.1.4</li>
<li>Ruby: 2.7.5</li>
<li>Redis: 6.2.3</li>
</ul>
<hr>
<h2 id="hobby_dev-と-premiumの違い">Hobby_Dev と Premiumの違い</h2>
<p>Hobby_DevではTLSの有無に関わらず接続が可能だが、PremiumでかつRedisのバージョンが6の場合は、<strong>TLS接続が必須</strong>となっている。</p>
<p>ただし、<a href="https://devcenter.heroku.com/articles/securing-heroku-redis#stunnel-overview">Heroku側で設定は自動で行ってくれている</a>ので、クライアント側ではSSLでの接続をオフにするように設定を追加するだけで良い。</p>
<hr>
<h2 id="クライアントrailsでの対応">クライアント（Rails）での対応</h2>
<h3 id="redisインスタンスの初期設定">Redisインスタンスの初期設定</h3>
<p><code>config/initializers</code>ディレクトリ直下に、<code>redis.rb</code>ファイルを作成し、Redisインスタンスの設定を追加。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#66d9ef">if</span> <span style="color:#66d9ef">Rails</span><span style="color:#f92672">.</span>env<span style="color:#f92672">.</span>production?
  $redis <span style="color:#f92672">=</span> <span style="color:#66d9ef">Redis</span><span style="color:#f92672">.</span>new(<span style="color:#e6db74">url</span>: <span style="color:#66d9ef">ENV</span><span style="color:#f92672">[</span><span style="color:#e6db74">&#34;REDIS_URL&#34;</span><span style="color:#f92672">]</span>, <span style="color:#e6db74">ssl_params</span>: { <span style="color:#e6db74">verify_mode</span>: <span style="color:#66d9ef">OpenSSL</span><span style="color:#f92672">::</span><span style="color:#66d9ef">SSL</span><span style="color:#f92672">::</span><span style="color:#66d9ef">VERIFY_NONE</span> })
<span style="color:#66d9ef">end</span>
</code></pre></div><h3 id="action-cableの設定">Action Cableの設定</h3>
<p><code>config/cable.yml</code>ファイル内にも、設定を追加。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#f92672">production</span>:
  <span style="color:#f92672">adapter</span>: <span style="color:#ae81ff">redis</span>
  <span style="color:#f92672">url</span>: <span style="color:#ae81ff">&lt;%=ENV[&#39;REDIS_URL&#39;]%&gt;</span>
  <span style="color:#75715e"># ここから下を新しく追加</span>
  <span style="color:#f92672">ssl_params</span>:
    <span style="color:#f92672">verify_mode</span>: <span style="color:#ae81ff">&lt;%= OpenSSL::SSL::VERIFY_NONE %&gt;</span>
</code></pre></div><h2 id="所感">所感</h2>
<p>公式ドキュメントにしっかりと書いてあったので、とても助かった。
そして今までありがとうFreeプラン。フォーエバーFreeプラン。</p>
<h2 id="参考文献">参考文献</h2>
<ul>
<li><a href="https://blog.heroku.com/next-chapter">Heroku&rsquo;s Next Chapter - Heroku</a></li>
<li><a href="https://devcenter.heroku.com/ja/articles/heroku-redis">Heroku Redis - Heroku</a></li>
<li><a href="https://devcenter.heroku.com/ja/articles/heroku-redis-version-upgrade">Heroku Redisバージョンのアップグレード - Heroku</a></li>
<li><a href="https://devcenter.heroku.com/ja/articles/connecting-heroku-redis">Heroku Redisへの接続 - Heroku</a></li>
<li><a href="https://devcenter.heroku.com/ja/articles/securing-heroku-redis">Heroku Redis バージョン4と5のセキュリティ保護 - Heroku</a></li>
</ul>
</div>
      </section>
      <footer>
  <p>&copy; 2022 Radish All rights reserved. </p>
</footer>
    </main>
  </body>
</html>
